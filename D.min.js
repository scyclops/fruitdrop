/* (c) Jonathan Gotti - licence: https://github.com/malko/d.js/LICENCE.txt */
(function(){"use strict";function n(n){t(function(){throw n})}var t,r=function(n){return n instanceof Function},e=function(n){return!!~[void 0,null,!1].indexOf(n)},u=function(n,t){return[].slice.apply(n,t)},i="undefined",o="length",c="promise",f="resolve",s="reject",l="then";if(typeof process!==i&&process.nextTick)t=process.nextTick;else if(typeof MessageChannel!==i){var a=new MessageChannel,p=[];a.port1.onmessage=function(){p[o]&&p.shift()()},t=function(n){p.push(n),a.port2.postMessage(0)}}else t=function(n){setTimeout(n,0)};var h=function(u){function i(n){n&&n.call(null,v)}function a(){if(0!==d){var n=m,t=0,r=n[o],e=~d?0:1;for(m=[];r>t;t++)i(n[t][e])}}function p(n){return d?this:n&&r(n[l])?(n[l](p,y),this):(v=n,d=1,u?t(a):a(),this)}function y(n){if(0!==d)return this;try{throw n}catch(r){v=r}return d=-1,u?t(a):a(),this}u||(u=h.alwaysAsync);var v,d=0,m=[],g=h.onlyFuncs,w={then:function(n,i){var o=h();return m.push([function(t){try{o[f](e(n)?t:r(n)?n.call(null,t):g?t:n)}catch(u){o[s](u)}},function(n){if((e(i)||!r(i)&&g)&&o[s](n),i)try{o[f](r(i)?i.call(null,n):i)}catch(t){o[s](t)}}]),0!==d&&(u?t(a):a()),o[c]},success:function(n){return this[l](n,null)},error:function(n){return this[l](null,n)},apply:function(n,t){return this[l](function(t){return r(n)?n.apply(null,t):g?t:n},t||null)},rethrow:function(t){return this[l](null,t?function(n){throw t(n),n}:n)},isPending:function(){return 0===d?!0:!1},getStatus:function(){return d}};return w.toSource=w.toString=w.valueOf=function(){return void 0===v?this:v},{promise:w,resolve:p,fulfill:p,reject:y}};h.defer=h,h.nextTick=t,h.alwaysAsync=!0,h.onlyFuncs=!0,h.resolved=h.fulfilled=function(n){return h(!0)[f](n)[c]},h.rejected=function(n){return h(!0)[s](n)[c]},h.wait=function(n){var t=h();return setTimeout(t[f],n||0),t[c]},h.delay=function(n,t){var r=h();return setTimeout(function(){try{r[f](n.apply(null))}catch(t){r[s](t)}},t||0),r[c]},h.promisify=function(n){return n&&r(n[l])?n:d.resolved(n)},h.all=function(){var n=arguments;if(1===n[o]&&n[0]instanceof Array){if(n[0][o])return h.all.apply(h,n[0]);var t=h();return t[f](n[0]),t[c]}var r=[],e=h(),i=u(n),a=i[o];if(a)for(var p=0,y=a;y>p;p++)(function(n){var t=h.promisify(i[n]);t[l](function(t){n in r||(r[n]=t,--a||e[f](r))},function(t){n in r||e[s](t)})})(p);else e[f](r);return e[c]},h.nodeCapsule=function(n,t){return t||(t=n,n=void 0),function(){var r=h(),e=u(arguments);e.push(function(n,t){n?r[s](n):r[f](arguments[o]>2?u(arguments,1):t)});try{t.apply(n,e)}catch(i){r.reject(i)}return r[c]}},typeof window!==i?window.D=h:module.exports=h})();